package patches.buildTypes

import jetbrains.buildServer.configs.kotlin.*
import jetbrains.buildServer.configs.kotlin.buildSteps.ScriptBuildStep
import jetbrains.buildServer.configs.kotlin.buildSteps.nodeJS
import jetbrains.buildServer.configs.kotlin.buildSteps.script
import jetbrains.buildServer.configs.kotlin.ui.*

/*
This patch script was generated by TeamCity on settings change in UI.
To apply the patch, change the buildType with id = 'FcalenderFrontendBuild'
accordingly, and delete the patch script.
*/
changeBuildType(RelativeId("FcalenderFrontendBuild")) {
    expectSteps {
        nodeJS {
            id = "jest"
            shellScript = """
                source /etc/profile
                cd frontend
                npm ci
                npm run test
            """.trimIndent()
            dockerImage = "kvtodev/ci-containers:js"
            dockerPull = true
        }
        script {
            id = "build apk"
            scriptContent = """
                cd frontend
                source /etc/profile
                
                npm ci
                npx expo prebuild --platform android
                
                sh patch.sh
                
                cd android
                yes | sdkmanager --licenses
                ./gradlew assembleRelease --no-daemon --parallel --warning-mode all
            """.trimIndent()
            dockerImage = "kvtodev/ci-containers:react-native"
            dockerPull = true
            dockerRunParameters = "--rm -v /root/.m2:/root/.m2 -v /root/.gradle:/root/.gradle/ -v /opt/android-sdk:/opt/android-sdk"
        }
        script {
            name = "Source of Release"
            scriptContent = """
                ensure_binary() {
                    local binary_name="${'$'}1"
                    local download_url="${'$'}2"
                    local max_retries=3
                
                    if [ -z "${'$'}binary_name" ] || [ -z "${'$'}download_url" ]; then
                        echo "Error: ensure_binary requires two arguments: binary_name and download_url" >&2
                        exit 1
                    fi
                    
                    local retry=0
                    while [ ${'$'}retry -lt ${'$'}max_retries ]; do
                        if curl -fsSL -o "${'$'}{binary_name}" "${'$'}{download_url}"; then
                            chmod +x "${'$'}{binary_name}"
                            if [ ${'$'}? -eq 0 ]; then
                                echo "'${'$'}{binary_name}' downloaded and permissions set successfully."
                                return 0
                            else
                                echo "Failed to make '${'$'}{binary_name}' executable." >&2
                                exit 1
                            fi
                        else
                            echo "Download attempt ${'$'}((retry + 1)) failed." >&2
                            retry=${'$'}((retry + 1))
                            if [ ${'$'}retry -lt ${'$'}max_retries ]; then
                                sleep 2
                            fi
                        fi
                    done
                
                    echo "Failed to download '${'$'}{binary_name}' after ${'$'}{max_retries} attempts, aborting." >&2
                    exit 1
                }
                ensure_binary gold https://rustfs.k88936.top/software-release/gold/v1.0.0/gold
                
                                            ./gold upload "Fcalender" "v%build.number%" "frontend/android/app/build/outputs/apk/release/app-release.apk"
            """.trimIndent()
        }
        script {
            name = "Source of Release"
            scriptContent = """
                ensure_binary() {
                    local binary_name="${'$'}1"
                    local download_url="${'$'}2"
                    local max_retries=3
                
                    if [ -z "${'$'}binary_name" ] || [ -z "${'$'}download_url" ]; then
                        echo "Error: ensure_binary requires two arguments: binary_name and download_url" >&2
                        exit 1
                    fi
                    
                    local retry=0
                    while [ ${'$'}retry -lt ${'$'}max_retries ]; do
                        if curl -fsSL -o "${'$'}{binary_name}" "${'$'}{download_url}"; then
                            chmod +x "${'$'}{binary_name}"
                            if [ ${'$'}? -eq 0 ]; then
                                echo "'${'$'}{binary_name}' downloaded and permissions set successfully."
                                return 0
                            else
                                echo "Failed to make '${'$'}{binary_name}' executable." >&2
                                exit 1
                            fi
                        else
                            echo "Download attempt ${'$'}((retry + 1)) failed." >&2
                            retry=${'$'}((retry + 1))
                            if [ ${'$'}retry -lt ${'$'}max_retries ]; then
                                sleep 2
                            fi
                        fi
                    done
                
                    echo "Failed to download '${'$'}{binary_name}' after ${'$'}{max_retries} attempts, aborting." >&2
                    exit 1
                }
                ensure_binary gold https://rustfs.k88936.top/software-release/gold/v1.0.0/gold
                
                                            ./gold upload "Fcalender" "latest" "frontend/android/app/build/outputs/apk/release/app-release.apk"
            """.trimIndent()
        }
        script {
            name = "Create GitHub Release"
            scriptContent = "gh release create --target %teamcity.build.branch% %teamcity.build.branch%-build-%build.number% --generate-notes frontend/android/app/build/outputs/apk/release/app-release.apk"
        }
    }
    steps {
        update<ScriptBuildStep>(1) {
            clearConditions()
            scriptContent = """
                cd frontend
                source /etc/profile
                
                npm ci
                npx expo prebuild --platform android
                
                sh patch.sh
                
                cd android
                yes | sdkmanager --licenses
                ./gradlew assembleRelease --no-daemon --parallel --warning-mode all -Dhttps.protocols=TLSv1.2,TLSv1.3
            """.trimIndent()
            param("teamcity.kubernetes.executor.pull.policy", "")
        }
    }
}
